# Настройка проброса портов на роутере Keenetic Lite

## Обзор

Для доступа к серверу из интернета необходимо настроить проброс портов (Port Forwarding) на роутере Keenetic Lite.

## Шаг 1: Определите локальный IP сервера

На сервере выполните:

```bash
ip addr show
# или
hostname -I
```

Найдите IP-адрес в локальной сети (обычно начинается с `192.168.` или `10.`).

**Пример:** `192.168.1.100`

## Шаг 2: Войдите в веб-интерфейс Keenetic

1. Откройте браузер
2. Перейдите по адресу: `http://192.168.1.1` (или адрес, указанный на наклейке роутера)
3. Введите логин и пароль администратора

**По умолчанию:**
- Логин: `admin`
- Пароль: `admin` или `1234` (зависит от версии прошивки)

## Шаг 3: Настройка проброса портов

### Вариант 1: Через веб-интерфейс (рекомендуется)

1. **Перейдите в раздел "Интернет" → "Виртуальные серверы"**
   - Или "Internet" → "Port Forwarding"
   - Или "Сеть" → "Проброс портов"

2. **Нажмите "Добавить" или "Создать правило"**

3. **Настройте правило для HTTP (порт 80):**
   - **Название:** `HTTP Web Server`
   - **Внешний порт:** `80`
   - **Внутренний IP:** `192.168.1.100` (IP вашего сервера)
   - **Внутренний порт:** `80`
   - **Протокол:** `TCP`
   - **Включено:** ✓

4. **Настройте правило для HTTPS (порт 443):**
   - **Название:** `HTTPS Web Server`
   - **Внешний порт:** `443`
   - **Внутренний IP:** `192.168.1.100` (IP вашего сервера)
   - **Внутренний порт:** `443`
   - **Протокол:** `TCP`
   - **Включено:** ✓

5. **Сохраните настройки**

### Вариант 2: Через командную строку (SSH/Telnet)

Если у вас есть доступ к командной строке Keenetic:

```bash
# Подключитесь к роутеру
telnet 192.168.1.1
# или
ssh admin@192.168.1.1

# Добавьте правило для HTTP
ip portmap add tcp 80 192.168.1.100 80

# Добавьте правило для HTTPS
ip portmap add tcp 443 192.168.1.100 443

# Сохраните конфигурацию
system configuration save
```

## Шаг 4: Настройка статического IP для сервера

**Важно:** Чтобы проброс портов работал стабильно, сервер должен иметь статический IP в локальной сети.

### На сервере (Linux):

1. **Отредактируйте конфигурацию сети:**

```bash
sudo nano /etc/netplan/01-netcfg.yaml
# или
sudo nano /etc/network/interfaces
```

2. **Установите статический IP:**

**Для Netplan (Ubuntu 18.04+):**
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:  # или ваше имя интерфейса
      dhcp4: no
      addresses:
        - 192.168.1.100/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
```

**Для /etc/network/interfaces:**
```
auto eth0
iface eth0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4
```

3. **Примените изменения:**

```bash
# Для Netplan
sudo netplan apply

# Для interfaces
sudo systemctl restart networking
```

### Альтернатива: Резервирование IP в Keenetic

Вместо настройки статического IP на сервере, можно зарезервировать IP в роутере:

1. В веб-интерфейсе Keenetic перейдите в **"Домашняя сеть" → "Устройства"**
2. Найдите ваш сервер в списке
3. Нажмите на устройство и выберите **"Зарезервировать IP"** или **"Привязать IP"**
4. Укажите IP-адрес (например, `192.168.1.100`)

## Шаг 5: Проверка работы проброса портов

### 1. Проверьте из локальной сети:

```bash
# На сервере
curl http://localhost
# или
curl http://192.168.1.100
```

### 2. Проверьте из интернета:

Используйте внешний IP-адрес роутера. Узнать его можно:

- В веб-интерфейсе Keenetic: **"Интернет" → "Статус"**
- Или через команду на сервере:
  ```bash
  curl ifconfig.me
  ```

Затем проверьте:
```bash
curl http://ВАШ_ВНЕШНИЙ_IP
```

### 3. Проверьте через онлайн-сервисы:

- https://www.yougetsignal.com/tools/open-ports/
- https://canyouseeme.org/

Введите порт `80` или `443` и проверьте, открыт ли он.

## Шаг 6: Настройка файрвола на сервере

Убедитесь, что на сервере разрешены входящие подключения на необходимые порты:

```bash
# Для UFW
# Основные порты веб-сервера
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Порты TURN сервера (КРИТИЧЕСКИ ВАЖНО для мобильных устройств!)
sudo ufw allow 3478/tcp
sudo ufw allow 3478/udp
sudo ufw allow 49152:65535/udp

# Проверьте статус
sudo ufw status

# Для iptables
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3478 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 3478 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 49152:65535 -j ACCEPT
```

## Дополнительные порты (опционально)

Если нужно пробросить другие порты:

- **SSH (22):** Для удаленного доступа к серверу
- **API (5000):** Если API работает на отдельном порте (обычно проксируется через Apache)
- **TURN сервер (3478):** **КРИТИЧЕСКИ ВАЖНО для работы видео на мобильных устройствах!**

### Проброс портов для TURN сервера (ОБЯЗАТЕЛЬНО для мобильных устройств)

TURN сервер необходим для работы WebRTC на мобильных устройствах. Без него видео не будет работать на Android/iOS.

#### Порты для TURN сервера:

1. **Основной порт TURN (3478):**
   - **Внешний порт:** `3478`
   - **Внутренний IP:** `192.168.1.100` (IP вашего сервера)
   - **Внутренний порт:** `3478`
   - **Протокол:** `TCP и UDP` (нужно создать два правила)

2. **Диапазон релейных портов (49152-65535):**
   - **Внешний порт:** `49152-65535`
   - **Внутренний IP:** `192.168.1.100`
   - **Внутренний порт:** `49152-65535`
   - **Протокол:** `UDP`

#### Настройка в Keenetic Lite:

1. **Перейдите в "Интернет" → "Виртуальные серверы"**

2. **Добавьте правило для TURN TCP:**
   - **Название:** `TURN Server TCP`
   - **Внешний порт:** `3478`
   - **Внутренний IP:** `192.168.1.100`
   - **Внутренний порт:** `3478`
   - **Протокол:** `TCP`
   - **Включено:** ✓

3. **Добавьте правило для TURN UDP:**
   - **Название:** `TURN Server UDP`
   - **Внешний порт:** `3478`
   - **Внутренний IP:** `192.168.1.100`
   - **Внутренний порт:** `3478`
   - **Протокол:** `UDP`
   - **Включено:** ✓

4. **Добавьте правило для релейных портов:**
   - **Название:** `TURN Relay Ports`
   - **Внешний порт:** `49152-65535` (или `49152:65535` в зависимости от интерфейса)
   - **Внутренний IP:** `192.168.1.100`
   - **Внутренний порт:** `49152-65535`
   - **Протокол:** `UDP`
   - **Включено:** ✓

**Примечание:** Если Keenetic не поддерживает диапазоны портов напрямую, можно:
- Пробросить только основные порты (3478 TCP/UDP)
- Или использовать UPnP (если поддерживается)
- Или настроить вручную через командную строку

#### Через командную строку Keenetic:

```bash
# Подключитесь к роутеру
telnet 192.168.1.1
# или
ssh admin@192.168.1.1

# TURN TCP
ip portmap add tcp 3478 192.168.1.100 3478

# TURN UDP
ip portmap add udp 3478 192.168.1.100 3478

# Релейные порты (если поддерживается диапазон)
# Или пробросьте несколько портов вручную
ip portmap add udp 49152 192.168.1.100 49152
ip portmap add udp 50000 192.168.1.100 50000
# ... и т.д.

# Сохраните конфигурацию
system configuration save
```

#### Проверка работы TURN сервера:

После настройки проброса портов проверьте:

```bash
# На сервере проверьте, что TURN сервер запущен
sudo systemctl status coturn

# Проверьте, что порты слушаются
sudo netstat -tulpn | grep 3478

# Проверьте логи TURN сервера
sudo tail -f /var/log/turnserver.log
```

#### Проверка извне:

Используйте онлайн-инструменты для проверки открытых портов:
- https://www.yougetsignal.com/tools/open-ports/
- https://canyouseeme.org/

Введите порт `3478` и проверьте, открыт ли он.

### Пример для SSH:

1. В веб-интерфейсе Keenetic добавьте правило:
   - **Внешний порт:** `2222` (не используйте 22 для безопасности)
   - **Внутренний IP:** `192.168.1.100`
   - **Внутренний порт:** `22`
   - **Протокол:** `TCP`

2. Подключение:
   ```bash
   ssh user@ВАШ_ВНЕШНИЙ_IP -p 2222
   ```

## Решение проблем

### Проблема: Проброс портов не работает

**Решения:**
1. Проверьте, что сервер имеет статический IP
2. Убедитесь, что на сервере разрешены входящие подключения (firewall)
3. Проверьте, что Apache слушает на правильном порту:
   ```bash
   sudo netstat -tulpn | grep apache
   ```
4. Проверьте логи Apache:
   ```bash
   sudo tail -f /var/log/apache2/error.log
   ```

### Проблема: Внешний IP меняется

Если у вас динамический IP, используйте DynDNS:

1. В Keenetic перейдите в **"Интернет" → "Динамический DNS"**
2. Зарегистрируйтесь на сервисе (например, noip.com, duckdns.org)
3. Настройте DynDNS в роутере

### Проблема: Роутер не позволяет пробросить порты

Некоторые провайдеры используют **CGNAT** (Carrier-Grade NAT), что блокирует проброс портов.

**Решения:**
1. Обратитесь к провайдеру и попросите выделенный IP-адрес
2. Используйте VPN или туннелирование
3. Используйте облачный сервер вместо домашнего

## Безопасность

⚠️ **Важно:** После настройки проброса портов ваш сервер будет доступен из интернета.

**Рекомендации:**
1. Используйте **HTTPS** (SSL-сертификаты)
2. Настройте **fail2ban** для защиты от брутфорса
3. Регулярно обновляйте систему и приложения
4. Используйте сильные пароли
5. Ограничьте доступ к SSH (используйте ключи вместо паролей)
6. Настройте файрвол на сервере

## Проверка конфигурации

После настройки проверьте:

```bash
# 1. Статический IP сервера
ip addr show

# 2. Проброс портов работает
curl http://ВАШ_ВНЕШНИЙ_IP

# 3. Apache слушает на портах
sudo netstat -tulpn | grep -E "80|443"

# 4. Файрвол разрешает подключения
sudo ufw status
```

## Готово!

После настройки проброса портов ваш сервер будет доступен по домену `bigo.1tlt.ru` из интернета.

