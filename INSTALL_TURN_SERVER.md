# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TURN —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

TURN (Traversal Using Relays around NAT) —Å–µ—Ä–≤–µ—Ä –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã WebRTC –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö. –ë–µ–∑ TURN —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –∏–∑-–∑–∞ NAT –∏ —Ñ–∞–π—Ä–≤–æ–ª–æ–≤.

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Coturn

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
sudo apt update

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ coturn –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt install -y coturn
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Coturn

#### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

```bash
sudo nano /etc/turnserver.conf
```

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```ini
# –õ–æ–∫–∞–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
listening-ip=0.0.0.0

# –ü—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π IP)
external-ip=YOUR_SERVER_IP

# –ü–æ—Ä—Ç –¥–ª—è TURN
listening-port=3478

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç –¥–ª—è —Ä–µ–ª–µ–π–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
min-port=49152

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç –¥–ª—è —Ä–µ–ª–µ–π–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
max-port=65535

# –í–∫–ª—é—á–∏—Ç—å TURN
relay-ip=0.0.0.0

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
static-auth-secret=YOUR_SECRET_KEY_HERE

# Realm (–¥–æ–º–µ–Ω)
realm=bigo.1tlt.ru

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
log-file=/var/log/turnserver.log
verbose

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
no-cli
no-tls
no-dtls

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á)
# user=username:password
```

#### 2.2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á
openssl rand -hex 32
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ `static-auth-secret`.

#### 2.3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP

```bash
# –£–∑–Ω–∞–π—Ç–µ –≤–∞—à –ø—É–±–ª–∏—á–Ω—ã–π IP
curl ifconfig.me
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è, –µ—Å–ª–∏ –æ–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.

### –®–∞–≥ 3: –í–∫–ª—é—á–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ Coturn

#### 3.1. –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é systemd
sudo nano /etc/default/coturn
```

–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É:
```bash
TURNSERVER_ENABLED=1
```

#### 3.2. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
sudo systemctl restart coturn

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status coturn

# –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
sudo systemctl enable coturn
```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞

```bash
# –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã –¥–ª—è TURN
sudo ufw allow 3478/udp
sudo ufw allow 3478/tcp
sudo ufw allow 49152:65535/udp
sudo ufw allow 49152:65535/tcp

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª
sudo ufw status
```

## üîß –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª—é—á–∞:

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ /etc/turnserver.conf
user=admin:password123
user=streamer:password456
```

### 2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### Backend (.env)

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª –±—ç–∫–µ–Ω–¥–∞:

```env
TURN_SERVER_URL=turn:bigo.1tlt.ru:3478
TURN_SERVER_SECRET=YOUR_SECRET_KEY_HERE
```

### Frontend (.env.local –∏–ª–∏ .env)

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env.local` —Ñ–∞–π–ª —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:

```env
NEXT_PUBLIC_WEBRTC_TURN_SERVER=turn:bigo.1tlt.ru:3478
NEXT_PUBLIC_WEBRTC_TURN_USERNAME=admin
NEXT_PUBLIC_WEBRTC_TURN_PASSWORD=password123
```

**–ò–ª–∏** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):

```env
NEXT_PUBLIC_WEBRTC_TURN_SERVER=turn:bigo.1tlt.ru:3478
NEXT_PUBLIC_WEBRTC_TURN_SECRET=YOUR_SECRET_KEY_HERE
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã TURN —Å–µ—Ä–≤–µ—Ä–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
sudo tail -f /var/log/turnserver.log

# –ò–ª–∏ —á–µ—Ä–µ–∑ journalctl
sudo journalctl -u coturn -f
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Trickle ICE

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
2. –í–≤–µ–¥–∏—Ç–µ:
   - **STUN or TURN URI**: `turn:bigo.1tlt.ru:3478`
   - **TURN username**: `admin` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
   - **TURN password**: `password123` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
3. –ù–∞–∂–º–∏—Ç–µ "Add Server" –∏ "Gather candidates"
4. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Ç–∏–ø–∞ `relay` (—ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ TURN —Ä–∞–±–æ—Ç–∞–µ—Ç)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ—Ä—Ç 3478 —Å–ª—É—à–∞–µ—Ç—Å—è
sudo netstat -tulpn | grep 3478

# –ò–ª–∏
sudo ss -tulpn | grep 3478
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á** (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
2. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø** –∫ TURN —Å–µ—Ä–≤–µ—Ä—É –ø–æ IP (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TLS/DTLS** –¥–ª—è production (—Ç—Ä–µ–±—É–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
5. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ rate limiting** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TLS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è production)

```ini
# –í /etc/turnserver.conf
cert=/etc/letsencrypt/live/bigo.1tlt.ru/fullchain.pem
pkey=/etc/letsencrypt/live/bigo.1tlt.ru/privkey.pem
tls-listening-port=5349
```

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: TURN —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo turnserver -c /etc/turnserver.conf --log-file=/var/log/turnserver.log

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo tail -50 /var/log/turnserver.log
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `external-ip` —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ 49152-65535 –æ—Ç–∫—Ä—ã—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

```bash
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
max-bps=1000000
max-allocate-timeout=60
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
sudo nano /usr/local/bin/check-turn.sh
```

```bash
#!/bin/bash
if systemctl is-active --quiet coturn; then
    echo "TURN —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
    exit 0
else
    echo "TURN —Å–µ—Ä–≤–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é..."
    sudo systemctl restart coturn
    exit 1
fi
```

```bash
sudo chmod +x /usr/local/bin/check-turn.sh
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron

```bash
sudo crontab -e
```

–î–æ–±–∞–≤—å—Ç–µ:
```cron
*/5 * * * * /usr/local/bin/check-turn.sh
```

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TURN —Å–µ—Ä–≤–µ—Ä–∞:

1. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

TURN —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, Tecno Pova 5).

